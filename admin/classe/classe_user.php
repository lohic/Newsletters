<?phpinclude_once('classe_connexion.php');include_once('fonctions.php');class User {	var $connexion;	var $isAdmin;	var $info;	var $id;	var $login;	var $password;	var $type;	var $nom;	var $prenom;	var $email;	var $groupe;	function user($connexion){		$this->isAdmin = false;		$this->id		= NULL;		$this->login	= NULL;		$this->password	= NULL;		$this->type		= NULL;		$this->nom		= NULL;		$this->prenom	= NULL;		$this->email	= NULL;		$this->groupe	= NULL;		$this->connexion = $connexion;				if(isset($_POST['logout']) && $_POST['logout']== true){			//echo "LOGOUT OK";			$_SESSION['id']		= NULL;			$_SESSION['login']	= NULL;			$_SESSION['type']	= NULL;			$_SESSION['nom']	= NULL;			$_SESSION['prenom']	= NULL;			$_SESSION['email']	= NULL;			$_SESSION['groupe'] = NULL;			unset($_SESSION['id']);			unset($_SESSION['login']);			unset($_SESSION['type']);			unset($_SESSION['nom']);			unset($_SESSION['prenom']);			unset($_SESSION['email']);			unset($_SESSION['groupe']);			$this->id		= NULL;			$this->login	= NULL;			$this->type		= NULL;			$this->nom		= NULL;			$this->prenom	= NULL;			$this->email	= NULL;			$this->groupe	= NULL;			$this->isAdmin	= false;			//header('Location:index.php');			//exit;				}else if(isset($_SESSION['login'])){			//echo "SESSION OK ".$_SESSION['login'];						$this->id		= $_SESSION['id'];			$this->login	= $_SESSION['login'];			$this->type		= $_SESSION['type'];			$this->nom		= $_SESSION['nom'];			$this->prenom	= $_SESSION['prenom'];			$this->email	= $_SESSION['email'];			$this->groupe	= $_SESSION['groupe'];				$this->isAdmin	= true;		}else if(isset($_POST['login']) && isset($_POST['password'])){			//echo "POST LOGIN OK";			$this->check_login($_POST['login'],$_POST['password']);		}else{			//echo "USER RIEN";			$this->isAdmin	= false;					}			}		function check_login($login=NULL,$password=NULL){		$this->connexion->connect_db();				$login__query	= sprintf("SELECT * FROM user_tb WHERE login=%s AND password=%s",																GetSQLValueString($login, "text"),																GetSQLValueString($password, "text")); 			$login_info		= mysql_query($login__query) or die(mysql_error());		$infoUser		= mysql_fetch_assoc($login_info);		$loginuser		= mysql_num_rows($login_info);		//echo "INFO USER  : ".$infoUser['login'];			if($loginuser){						//echo "INFO USER 2  : ".$infoUser['login'];			$this->id		= $infoUser['id'];			$this->login	= $infoUser['login'];			$this->password	= $infoUser['password'];			$this->type		= $infoUser['type'];			$this->nom		= $infoUser['nom'];			$this->prenom	= $infoUser['prenom'];			$this->email	= $infoUser['email'];			$this->groupe	= $infoUser['groupe'];			$_SESSION['id'] 	= $this->id;			$_SESSION['login']	= $this->login;			$_SESSION['type']	= $this->type;			$_SESSION['nom']	= $this->nom;			$_SESSION['prenom'] = $this->prenom;			$_SESSION['email']	= $this->email;			$_SESSION['groupe']	= $this->groupe;			//echo "SESSION USER 3  : ".$_SESSION['login'];			$this->isAdmin	= true;		}else{			$this->isAdmin	= false;		}	}		function logout(){		//////////// DECONNECTION /////////		//initialize the session				// ** Logout the current user. **		$logoutAction = $_SERVER['PHP_SELF']."?doLogout=true";		if ((isset($_SERVER['QUERY_STRING'])) && ($_SERVER['QUERY_STRING'] != "")){			$logoutAction .="&". htmlentities($_SERVER['QUERY_STRING']);		}				if ((isset($_GET['doLogout'])) &&($_GET['doLogout']=="true")){			//to fully log out a visitor we need to clear the session varialbles			$_SESSION['MM_Username'] = NULL;			$_SESSION['MM_UserID'] = NULL;			$_SESSION['MM_UserGroup'] = NULL;			$_SESSION['PrevUrl'] = NULL;			/* loic */ $_SESSION['admin_name'] = NULL;			unset($_SESSION['MM_Username']);			unset($_SESSION['MM_UserID']);			unset($_SESSION['MM_UserGroup']);			unset($_SESSION['PrevUrl']);			/* loic */ unset($_SESSION['admin_name']);						//$query = preg_replace("/?doLogout=true/", "?", $_SERVER['QUERY_STRING']);			$query="";						$logoutGoTo = "index.php".$query;			if ($logoutGoTo) {				header("Location: $logoutGoTo");				exit;			}		}		return $logoutAction;	}	function show_user_info($isAdmin){		if($isAdmin){			$this->info = $this->get_user_info();			//$login = $_SESSION['MM_UserID'];			//$user_info =sprintf("SELECT * FROM user_tb WHERE id=%s",GetSQLValueString($login, "int")); 			//$user_info_query = mysql_query($user_info) or die(mysql_error());			//$user_info_row = mysql_fetch_assoc($user_info_query);			/*			$id			= $user_info_row['id'];			$login		= $user_info_row['login'];			$password	= $user_info_row['password'];			$type		= $user_info_row['type'];			$nom		= $user_info_row['nom'];			$prenom		= $user_info_row['prenom'];			$email		= $user_info_row['email'];			$groupe		= $user_info_row['groupe'];			*/			$id 		= $this->id;				$login 		= $this->login;			$password	= $this->password;			$type		= $this->type;				$nom		= $this->nom;			$prenom		= $this->prenom;			$email		= $this->email;			$groupe		= $this->groupe;							include("structure_admin/user.php");		}	}		function get_user_info(){		if($this->isAdmin){			$retour = NULL;						/*$login = $_SESSION['MM_UserID'];			$user_info =sprintf("SELECT * FROM user_tb WHERE id=%s",GetSQLValueString($login, "int")); 			$user_info_query = mysql_query($user_info) or die(mysql_error());			$user_info_row = mysql_fetch_assoc($user_info_query);						$retour->id			= $user_info_row['id'];			$retour->login		= $user_info_row['login'];			$retour->password	= $user_info_row['password'];			$retour->type		= $user_info_row['type'];			$retour->nom		= $user_info_row['nom'];			$retour->prenom		= $user_info_row['prenom'];			$retour->email		= $user_info_row['email'];			$retour->groupe		= $user_info_row['groupe'];*/			//echo "USER INFO ADMIN";			$retour->id			= $this->id;			$retour->login		= $this->login;			$retour->password	= $this->password;			$retour->type		= $this->type;			$retour->nom		= $this->nom;			$retour->prenom		= $this->prenom;			$retour->email		= $this->email;			$retour->groupe		= $this->groupe;			$retour->isAdmin	= $this->isAdmin;						return $retour;		}else{			return false;		}	}		function update_user($isAdmin){		if($isAdmin){			$tab_valeur=array();			$id						= $_POST['id'];			$tab_valeur['password']	= $_POST['password'];			$tab_valeur['type']		= $_POST['type'];			$tab_valeur['nom']		= $_POST['nom'];			$tab_valeur['prenom']	= $_POST['prenom'];			$tab_valeur['email']	= $_POST['email'];			$tab_valeur['groupe']	= $_POST['groupe'];						$tab_valeur = $this->get_post_value($tab_valeur);						$lesvaleurstab = array();			foreach($tab_valeur as $key => $value){				array_push($lesvaleurstab,$key."=".$value);			}			$lesvaleurs 	= implode(',',array_values($lesvaleurstab));						$updateSQL 		= "UPDATE user_tb SET ".$lesvaleurs." WHERE id=".GetSQLValueString($id,"int");			$update_query	= mysql_query($updateSQL) or die(mysql_error());						$_SESSION['admin_name'] = $_POST['prenom'].' '.$_POST['nom'];			$_SESSION['MM_UserGroup'] = $_POST['type'];			$this->adminName = $_SESSION['admin_name'];						return $updateSQL ;		}	}		function get_post_value($tab){		$titre_item_attendu = array('password','type','nom','prenom','email','groupe');		$type_item_attendu 	= array('text','text','text','text','text','text');		$nbr_colonnes		= count($titre_item_attendu);			foreach($tab as $key => $value){			for($i=0;$i<$nbr_colonnes;$i++){				if($key==$titre_item_attendu[$i]){					$tab[$key] = GetSQLValueString($value,$type_item_attendu[$i]);					break;				}			}		}				return $tab;	}}?>